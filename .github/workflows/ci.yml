on:
  push

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install pipenv
        run: pip install pipenv

      - name: Install Core Utilities
        run: make install

      - name: Install Dependencies
        run: make deps

      - name: Install Panther CLI
        run: pipenv run -- pip3 install -e .

      - name: Run CLI Tests
        run: make ci

  testPublish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      # - name: Install pipenv
      #   run: pip install pipenv

      - name: Test building a release will work
        run: |
          rm -rf dist
          pipenv run python3 setup.py sdist
          pipenv run pip install dist/*.tar.gz
          pipenv run panther_analysis_tool --version

      - name: Test publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip_existing: true
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/